<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>äº”åéŸ³å®Ÿè·µç‰ˆ - Alexæ—¥è¯­å­¦ä¹ </title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;600;700;900&family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#FFF5F0;--card-bg:#FFFFFF;--text:#2D2A24;--text-sub:#7A7468;
  --shadow:0 2px 16px rgba(45,42,36,.08);--r:16px;--rs:10px;
  --accent:#D4557A;--accent-light:#F8D8E4;
  --row-a:#E8573A;--row-ka:#2B7A98;--row-sa:#3A8F5C;--row-ta:#7B5EA7;
  --row-na:#D4903A;--row-ha:#2B8F8F;--row-ma:#D4557A;--row-ya:#B8860B;
  --row-ra:#4A90D9;--row-wa:#7A7468;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html{scroll-behavior:smooth}
body{font-family:'Noto Sans SC','M PLUS Rounded 1c',sans-serif;background:var(--bg);color:var(--text);line-height:1.6;overflow-x:hidden;min-height:100vh}

.header{position:relative;overflow:hidden;padding:32px 20px 24px;text-align:center;background:linear-gradient(135deg,#D4557A 0%,#B83A5A 50%,#9A2040 100%);color:#fff}
.header::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle at 30% 40%,rgba(255,255,255,.1) 0%,transparent 50%)}
.header h1{font-family:'M PLUS Rounded 1c','Noto Sans SC',sans-serif;font-size:24px;font-weight:900;letter-spacing:1px;text-shadow:0 2px 8px rgba(0,0,0,.2);position:relative}
.header .sub{font-size:13px;opacity:.85;margin-top:4px;position:relative}
.back-link{position:absolute;left:16px;top:16px;color:#fff;text-decoration:none;font-size:24px;opacity:.7;z-index:10}
.back-link:hover{opacity:1}

/* Control bar */
.control-bar{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:var(--bg);position:sticky;top:0;z-index:100;border-bottom:1px solid rgba(0,0,0,.05)}
.toggle-label{display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;font-weight:700;color:var(--text-sub)}
.toggle-label input{display:none}
.toggle-slider{width:40px;height:22px;background:#ccc;border-radius:11px;position:relative;transition:background .3s}
.toggle-slider::after{content:'';position:absolute;top:2px;left:2px;width:18px;height:18px;background:#fff;border-radius:50%;transition:transform .3s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
.toggle-label input:checked+.toggle-slider{background:var(--accent)}
.toggle-label input:checked+.toggle-slider::after{transform:translateX(18px)}
.progress-mini{display:flex;align-items:center;gap:8px;font-size:12px;font-weight:700;color:var(--text-sub)}
.prog-bar{width:80px;height:6px;background:#e8e4dc;border-radius:3px;overflow:hidden}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--row-a));border-radius:3px;transition:width .4s;width:0}

/* Main tabs */
.main-tabs{display:flex;gap:0;background:var(--bg);position:sticky;top:43px;z-index:99;border-bottom:1px solid rgba(0,0,0,.05)}
.main-tab{flex:1;padding:10px;text-align:center;font-size:14px;font-weight:700;cursor:pointer;border:none;background:transparent;color:var(--text-sub);border-bottom:3px solid transparent;transition:all .2s}
.main-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.main-tab:active{background:rgba(0,0,0,.03)}

/* Section */
.section{display:none;padding-bottom:12px}
.section.active{display:block}

/* ============ CHART TABLE ============ */
.chart-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;padding:12px 8px}
.chart-title{text-align:center;font-size:17px;font-weight:900;color:var(--accent);margin:8px 0 12px}
.chart-table{width:100%;border-collapse:separate;border-spacing:3px;margin:0 auto}
.chart-table th{font-size:11px;font-weight:700;color:var(--accent);padding:4px 2px;text-align:center}
.chart-table .row-label{font-size:11px;font-weight:900;color:#fff;border-radius:8px;padding:4px 6px;text-align:center;min-width:30px}
.chart-cell{background:var(--card-bg);border-radius:10px;padding:6px 3px;text-align:center;border:2px solid #f0ece4;transition:all .2s;min-height:80px;vertical-align:top;position:relative}
.chart-cell.playing{border-color:var(--accent);box-shadow:0 0 0 2px var(--accent)}
.chart-cell.learned{background:#fef5f7}
.chart-cell.empty{background:transparent;border-color:transparent}
.chart-cell .kana-area{cursor:pointer;border-radius:6px;padding:2px;transition:background .15s}
.chart-cell .kana-area:active{background:rgba(212,85,122,.15);transform:scale(.95)}
.chart-cell .kana{font-family:'M PLUS Rounded 1c',sans-serif;font-size:24px;font-weight:900;line-height:1.1}
.chart-cell .roma{font-size:9px;color:var(--accent);font-weight:700;margin-top:1px;transition:opacity .3s}
.chart-cell .roma.hidden{opacity:0}
.chart-cell .word-area{cursor:pointer;border-radius:6px;padding:2px;margin-top:2px;transition:background .15s}
.chart-cell .word-area:active{background:rgba(232,107,138,.15);transform:scale(.95)}
.chart-cell .cell-img{width:28px;height:28px;object-fit:contain;margin:2px auto;display:block}
.chart-cell .word-text{font-size:9px;color:var(--text-sub);line-height:1.2}
.chart-cell .word-r{font-size:8px;color:var(--row-ra);font-weight:600}
.chart-btns{text-align:center;margin:12px 0 8px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap;padding:0 16px}
.chart-action-btn{padding:8px 16px;border-radius:20px;border:none;font-size:13px;font-weight:700;cursor:pointer;color:#fff;transition:opacity .2s}
.chart-action-btn:active{opacity:.7}
@media(max-width:480px){
  .chart-cell .kana{font-size:18px}
  .chart-cell .cell-img{width:22px;height:22px}
  .chart-cell{min-height:64px;padding:4px 2px}
}

/* ============ CARD VIEW ============ */
/* Row filter tabs */
.row-tabs{display:flex;gap:6px;padding:8px 16px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;background:var(--bg)}
.row-tabs::-webkit-scrollbar{display:none}
.row-tab{flex-shrink:0;padding:6px 14px;border-radius:20px;border:2px solid transparent;font-size:12px;font-weight:700;cursor:pointer;background:#fff;color:var(--text-sub);transition:all .2s;white-space:nowrap}
.row-tab.active{color:#fff;background:var(--accent);border-color:var(--accent)}

/* Row header */
.row-header{font-size:15px;font-weight:900;padding:8px 16px;border-radius:var(--rs);color:#fff;margin:16px 16px 8px;display:flex;align-items:center;gap:8px}
.play-row-btn{margin-left:auto;background:rgba(255,255,255,.25);border:none;color:#fff;font-size:11px;font-weight:700;padding:4px 12px;border-radius:12px;cursor:pointer}
.play-row-btn:active{opacity:.7}

/* Card Grid */
.card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;padding:0 16px 8px}
@media(min-width:600px){.card-grid{grid-template-columns:repeat(4,1fr)}}
@media(min-width:900px){.card-grid{grid-template-columns:repeat(5,1fr)}}

/* Single-face card */
.pcard{border-radius:var(--r);background:var(--card-bg);box-shadow:var(--shadow);border:2px solid #f0ece4;overflow:hidden;position:relative;transition:border-color .2s}
.pcard.playing{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent),0 4px 20px rgba(212,85,122,.2)}
.pcard.learned::after{content:'\2713';position:absolute;top:8px;left:10px;font-size:14px;color:#3A8F5C;font-weight:900;z-index:2}

/* Top: kana area */
.kana-top{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:14px 8px 10px;cursor:pointer;transition:background .15s;position:relative;border-bottom:1px dashed #f0ece4}
.kana-top:active{background:rgba(212,85,122,.08)}
.kana-top .big-kana{font-family:'M PLUS Rounded 1c',sans-serif;font-size:48px;font-weight:900;line-height:1}
.kana-top .romaji{font-size:14px;font-weight:700;color:var(--accent);margin-top:2px;transition:opacity .3s}
.kana-top .romaji.hidden{opacity:0}
.kana-top .kana-speaker{position:absolute;top:8px;right:8px;font-size:14px;opacity:.5}

/* Bottom: word area */
.word-bottom{display:flex;align-items:center;gap:10px;padding:10px 12px;cursor:pointer;transition:background .15s}
.word-bottom:active{background:rgba(232,107,138,.08)}
.word-bottom .word-img{width:56px;height:56px;object-fit:contain;flex-shrink:0;border-radius:8px}
.word-bottom .word-info{flex:1;min-width:0}
.word-bottom .word-jp{font-family:'M PLUS Rounded 1c',sans-serif;font-size:18px;font-weight:900;line-height:1.2}
.word-bottom .word-jp .hl{color:#E8573A}
.word-bottom .word-romaji{font-size:11px;color:var(--text-sub);transition:opacity .3s}
.word-bottom .word-romaji.hidden{opacity:0}
.word-bottom .word-cn{font-size:13px;color:var(--text-sub);font-weight:600}
.word-bottom .word-speaker{font-size:14px;opacity:.5;flex-shrink:0}

@media(max-width:400px){
  .kana-top .big-kana{font-size:38px}
  .word-bottom .word-img{width:44px;height:44px}
  .word-bottom .word-jp{font-size:16px}
}

/* Home button */
.home-btn{text-align:center;padding:24px 16px 32px}
.home-btn a{display:inline-block;padding:12px 24px;background:var(--card-bg);border-radius:var(--r);text-decoration:none;color:var(--text);font-weight:700;box-shadow:var(--shadow)}
</style>
</head>
<body>

<div class="header">
  <a class="back-link" href="../index.html">&#8592;</a>
  <h1>ğŸ´ äº”åéŸ³å®Ÿè·µç‰ˆ</h1>
  <div class="sub">ç‚¹å‡»å‡åå¬å‘éŸ³ Â· ç‚¹å‡»å•è¯å­¦è¯æ±‡</div>
</div>

<div class="control-bar">
  <label class="toggle-label">
    <input type="checkbox" id="romajiToggle" checked onchange="toggleRomaji()">
    <span class="toggle-slider"></span>
    ç½—é©¬å­—
  </label>
  <div class="progress-mini">
    <span id="progText">0/46</span>
    <div class="prog-bar"><div class="prog-fill" id="progFill"></div></div>
  </div>
</div>

<div class="main-tabs">
  <button class="main-tab active" onclick="switchMain(0)">ğŸ“Š äº”åéŸ³è¡¨</button>
  <button class="main-tab" onclick="switchMain(1)">ğŸ´ å•è¯å¡ç‰‡</button>
</div>

<!-- Section 0: Chart -->
<div class="section active" id="sec0">
  <div class="chart-title">ã²ã‚‰ãŒãª äº”åéŸ³</div>
  <div class="chart-wrap">
    <table class="chart-table" id="chartTable"></table>
  </div>
  <div class="chart-btns">
    <button class="chart-action-btn" style="background:var(--accent)" onclick="playAllChart(this)">ğŸ”Š å…¨éƒ¨è¿æ’­</button>
    <button class="chart-action-btn" style="background:var(--text-sub)" onclick="resetProgress()">ğŸ”„ é‡ç½®è¿›åº¦</button>
  </div>
</div>

<!-- Section 1: Cards -->
<div class="section" id="sec1">
  <nav class="row-tabs" id="rowTabs">
    <button class="row-tab active" data-key="all" onclick="switchRow('all')">å…¨éƒ¨</button>
    <button class="row-tab" data-key="a" onclick="switchRow('a')">ã‚è¡Œ</button>
    <button class="row-tab" data-key="ka" onclick="switchRow('ka')">ã‹è¡Œ</button>
    <button class="row-tab" data-key="sa" onclick="switchRow('sa')">ã•è¡Œ</button>
    <button class="row-tab" data-key="ta" onclick="switchRow('ta')">ãŸè¡Œ</button>
    <button class="row-tab" data-key="na" onclick="switchRow('na')">ãªè¡Œ</button>
    <button class="row-tab" data-key="ha" onclick="switchRow('ha')">ã¯è¡Œ</button>
    <button class="row-tab" data-key="ma" onclick="switchRow('ma')">ã¾è¡Œ</button>
    <button class="row-tab" data-key="ya" onclick="switchRow('ya')">ã‚„è¡Œ</button>
    <button class="row-tab" data-key="ra" onclick="switchRow('ra')">ã‚‰è¡Œ</button>
    <button class="row-tab" data-key="wa" onclick="switchRow('wa')">ã‚è¡Œ</button>
  </nav>
  <div id="cardContainer"></div>
</div>

<div class="home-btn">
  <a href="../index.html">&#8592; è¿”å›è¯¾ç¨‹åˆ—è¡¨</a>
</div>

<script src="../scripts/audio.js"></script>
<script src="../scripts/cache-control.js"></script>
<script src="../scripts/emoji-data.js"></script>
<script>
// ============================================================
// DATA
// ============================================================
var ROWS=[
  {name:'ã‚è¡Œ',key:'a',color:'var(--row-a)',hex:'#E8573A',chars:[
    {h:'ã‚',r:'a',word:'ã‚ã²ã‚‹',wr:'ahiru',cn:'é¸­å­',img:'gp_ahiru.png'},
    {h:'ã„',r:'i',word:'ã„ã¬',wr:'inu',cn:'ç‹—',img:'gp_inu.png'},
    {h:'ã†',r:'u',word:'ã†ã—',wr:'ushi',cn:'ç‰›',img:'gp_ushi.png'},
    {h:'ãˆ',r:'e',word:'ãˆã³',wr:'ebi',cn:'è™¾',img:'gp_ebi.png'},
    {h:'ãŠ',r:'o',word:'ãŠã†ã‚€',wr:'oumu',cn:'é¹¦é¹‰',img:'gp_oumu.png'}
  ]},
  {name:'ã‹è¡Œ',key:'ka',color:'var(--row-ka)',hex:'#2B7A98',chars:[
    {h:'ã‹',r:'ka',word:'ã‹ã‚',wr:'kame',cn:'ä¹Œé¾Ÿ',img:'gp_kame.png'},
    {h:'ã',r:'ki',word:'ãã‚Šã‚“',wr:'kirin',cn:'é•¿é¢ˆé¹¿',img:'gp_kirin.png'},
    {h:'ã',r:'ku',word:'ãã‚ãŒãŸ',wr:'kuwagata',cn:'é”¹å½¢è™«',img:'gp_kuwagata.png'},
    {h:'ã‘',r:'ke',word:'ã‘ã„ã¨',wr:'keito',cn:'æ¯›çº¿',img:'gp_keito.png'},
    {h:'ã“',r:'ko',word:'ã“ã„',wr:'koi',cn:'é²¤é±¼',img:'gp_koi.png'}
  ]},
  {name:'ã•è¡Œ',key:'sa',color:'var(--row-sa)',hex:'#3A8F5C',chars:[
    {h:'ã•',r:'sa',word:'ã•ã„',wr:'sai',cn:'çŠ€ç‰›',img:'gp_sai.png'},
    {h:'ã—',r:'shi',word:'ã—ã¾ã†ã¾',wr:'shimauma',cn:'æ–‘é©¬',img:'gp_shimauma.png'},
    {h:'ã™',r:'su',word:'ã™ãšã‚',wr:'suzume',cn:'éº»é›€',img:'gp_suzume.png'},
    {h:'ã›',r:'se',word:'ã›ã¿',wr:'semi',cn:'è‰',img:'gp_semi.png'},
    {h:'ã',r:'so',word:'ãã°',wr:'soba',cn:'èéº¦é¢',img:'gp_soba.png'}
  ]},
  {name:'ãŸè¡Œ',key:'ta',color:'var(--row-ta)',hex:'#7B5EA7',chars:[
    {h:'ãŸ',r:'ta',word:'ãŸã“',wr:'tako',cn:'ç« é±¼',img:'gp_tako.png'},
    {h:'ã¡',r:'chi',word:'ã¡ãã‚',wr:'chikuwa',cn:'ç«¹è½®',img:'gp_chikuwa.png'},
    {h:'ã¤',r:'tsu',word:'ã¤ã¿ã',wr:'tsumiki',cn:'ç§¯æœ¨',img:'gp_tsumiki.png'},
    {h:'ã¦',r:'te',word:'ã¦ã¶ãã‚',wr:'tebukuro',cn:'æ‰‹å¥—',img:'gp_tebukuro.png'},
    {h:'ã¨',r:'to',word:'ã¨ã‚“ã¼',wr:'tonbo',cn:'èœ»èœ“',img:'gp_tonbo.png'}
  ]},
  {name:'ãªè¡Œ',key:'na',color:'var(--row-na)',hex:'#D4903A',chars:[
    {h:'ãª',r:'na',word:'ãªã™',wr:'nasu',cn:'èŒ„å­',img:'gp_nasu.png'},
    {h:'ã«',r:'ni',word:'ã«ã‚“ã˜ã‚“',wr:'ninjin',cn:'èƒ¡èåœ',img:'gp_ninjin.png'},
    {h:'ã¬',r:'nu',word:'ã¬ã®',wr:'nuno',cn:'å¸ƒ',img:'gp_nuno.png'},
    {h:'ã­',r:'ne',word:'ã­ã“',wr:'neko',cn:'çŒ«',img:'gp_neko.png'},
    {h:'ã®',r:'no',word:'ã®ã“ãã‚Š',wr:'nokogiri',cn:'é”¯å­',img:'gp_nokogiri.png'}
  ]},
  {name:'ã¯è¡Œ',key:'ha',color:'var(--row-ha)',hex:'#2B8F8F',chars:[
    {h:'ã¯',r:'ha',word:'ã¯ã—',wr:'hashi',cn:'ç­·å­',img:'gp_hashi.png'},
    {h:'ã²',r:'hi',word:'ã²ã¨ã§',wr:'hitode',cn:'æµ·æ˜Ÿ',img:'gp_hitode.png'},
    {h:'ãµ',r:'fu',word:'ãµã†ã›ã‚“',wr:'fuusen',cn:'æ°”çƒ',img:'gp_fuusen.png'},
    {h:'ã¸',r:'he',word:'ã¸ã³',wr:'hebi',cn:'è›‡',img:'gp_hebi.png'},
    {h:'ã»',r:'ho',word:'ã»ã‚“',wr:'hon',cn:'ä¹¦',img:'gp_hon.png'}
  ]},
  {name:'ã¾è¡Œ',key:'ma',color:'var(--row-ma)',hex:'#D4557A',chars:[
    {h:'ã¾',r:'ma',word:'ã¾ã‚',wr:'mame',cn:'è±†',img:'gp_mame.png'},
    {h:'ã¿',r:'mi',word:'ã¿ã‹ã‚“',wr:'mikan',cn:'æ©˜å­',img:'gp_mikan.png'},
    {h:'ã‚€',r:'mu',word:'ã‚€ã—',wr:'mushi',cn:'è™«',img:'gp_mushi.png'},
    {h:'ã‚',r:'me',word:'ã‚ã‚ã‚“',wr:'meron',cn:'ç”œç“œ',img:'gp_meron.png'},
    {h:'ã‚‚',r:'mo',word:'ã‚‚ã‚‚',wr:'momo',cn:'æ¡ƒå­',img:'gp_momo.png'}
  ]},
  {name:'ã‚„è¡Œ',key:'ya',color:'var(--row-ya)',hex:'#B8860B',chars:[
    {h:'ã‚„',r:'ya',word:'ã‚„',wr:'ya',cn:'ç®­',img:'gp_ya.png'},
    {h:'ã‚†',r:'yu',word:'ã‚†ã‚Š',wr:'yuri',cn:'ç™¾åˆèŠ±',img:'gp_yuri.png'},
    {h:'ã‚ˆ',r:'yo',word:'ã‚ˆã£ã¨',wr:'yotto',cn:'å¸†èˆ¹',img:'gp_yotto.png'}
  ]},
  {name:'ã‚‰è¡Œ',key:'ra',color:'var(--row-ra)',hex:'#4A90D9',chars:[
    {h:'ã‚‰',r:'ra',word:'ã‚‰ã£ã±',wr:'rappa',cn:'å–‡å­',img:'gp_rappa.png'},
    {h:'ã‚Š',r:'ri',word:'ã‚Šã¼ã‚“',wr:'ribon',cn:'ç¼å¸¦',img:'gp_ribon.png'},
    {h:'ã‚‹',r:'ru',word:'ã‚‹ã‚ã‚',wr:'ruaa',cn:'è·¯äºšå‡é¥µ',img:'gp_ruaa.png'},
    {h:'ã‚Œ',r:'re',word:'ã‚Œã‚‚ã‚“',wr:'remon',cn:'æŸ æª¬',img:'gp_remon.png'},
    {h:'ã‚',r:'ro',word:'ã‚ã†ãã',wr:'rousoku',cn:'èœ¡çƒ›',img:'gp_rousoku.png'}
  ]},
  {name:'ã‚è¡Œ',key:'wa',color:'var(--row-wa)',hex:'#7A7468',chars:[
    {h:'ã‚',r:'wa',word:'ã‚ã«',wr:'wani',cn:'é³„é±¼',img:'gp_wani.png'},
    {h:'ã‚’',r:'wo',word:'ãˆã‚’ã‹ã',wr:'e wo kaku',cn:'ç”»ç”»',img:'gp_ewokaku.png',special:'ã‚’'},
    {h:'ã‚“',r:'n',word:'ã‹ã°ã‚“',wr:'kaban',cn:'ä¹¦åŒ…',img:'gp_kaban.png',special:'ã‚“'}
  ]}
];

// Build lookup: kana â†’ {rowIdx, charIdx}
var KANA_MAP={};
ROWS.forEach(function(r,ri){ r.chars.forEach(function(c,ci){ KANA_MAP[c.h]={ri:ri,ci:ci}; }); });

var showRomaji=true;
var currentRow='all';
var progress=JSON.parse(localStorage.getItem('gojuon_practice_progress')||'{}');

// ============================================================
// MAIN TAB SWITCH
// ============================================================
var mainIdx=0;
function switchMain(idx){
  mainIdx=idx;
  document.querySelectorAll('.main-tab').forEach(function(b,i){b.classList.toggle('active',i===idx)});
  document.querySelectorAll('.section').forEach(function(s,i){s.classList.toggle('active',i===idx)});
}

// ============================================================
// CHART TABLE (äº”åéŸ³è¡¨)
// ============================================================
function renderChart(){
  // Table layout: columns = rows (ã‚è¡Œã€œã‚è¡Œ), rows = vowels (ã‚æ®µã€œãŠæ®µ) + ã‚“
  var vowels=['a','i','u','e','o'];
  var vowelLabels=['ã‚æ®µ','ã„æ®µ','ã†æ®µ','ãˆæ®µ','ãŠæ®µ'];
  var rowKeys=['a','ka','sa','ta','na','ha','ma','ya','ra','wa'];

  // Build grid[vowelIdx][rowIdx] = char or null
  var grid=[];
  for(var v=0;v<5;v++){
    grid[v]=[];
    for(var rk=0;rk<rowKeys.length;rk++){
      var row=ROWS[rk];
      var found=null;
      for(var ci=0;ci<row.chars.length;ci++){
        var c=row.chars[ci];
        // Match vowel position
        var vowelMap={a:0,i:1,u:2,e:3,o:4,ka:0,ki:1,ku:2,ke:3,ko:4,sa:0,shi:1,su:2,se:3,so:4,ta:0,chi:1,tsu:2,te:3,to:4,na:0,ni:1,nu:2,ne:3,no:4,ha:0,hi:1,fu:2,he:3,ho:4,ma:0,mi:1,mu:2,me:3,mo:4,ya:0,yu:2,yo:4,ra:0,ri:1,ru:2,re:3,ro:4,wa:0,wo:4,n:0};
        if(vowelMap[c.r]===v && c.r!=='n') found=c;
      }
      grid[v][rk]=found;
    }
  }

  var html='<tr><th></th>';
  // Reverse order: ã‚ã€œã‚ (right to left = Japanese traditional)
  for(var rk=rowKeys.length-1;rk>=0;rk--){
    html+='<th style="color:'+ROWS[rk].hex+'">'+ROWS[rk].name.charAt(0)+'</th>';
  }
  html+='</tr>';

  // Vowel rows
  for(var v=0;v<5;v++){
    var labelColors=['var(--row-a)','var(--row-ka)','var(--row-sa)','var(--row-ta)','var(--row-na)'];
    html+='<tr><td class="row-label" style="background:'+labelColors[v]+'">'+vowelLabels[v]+'</td>';
    for(var rk=rowKeys.length-1;rk>=0;rk--){
      var c=grid[v][rk];
      if(!c){
        html+='<td class="chart-cell empty"></td>';
      }else{
        var learnedCls=progress[c.h]?' learned':'';
        html+='<td class="chart-cell'+learnedCls+'" data-kana="'+c.h+'">';
        html+='<div class="kana-area" onclick="event.stopPropagation();chartPlayKana(\''+c.h+'\')">';
        html+='<div class="kana" style="color:'+ROWS[rk].hex+'">'+c.h+'</div>';
        html+='<div class="roma'+(showRomaji?'':' hidden')+'">'+c.r+'</div>';
        html+='</div>';
        html+='<div class="word-area" onclick="event.stopPropagation();chartPlayWord(\''+c.h+'\')">';
        html+='<img class="cell-img" src="../img/'+c.img+'?v3" alt="'+c.cn+'">';
        html+='<div class="word-text">'+c.word+'</div>';
        html+='<div class="word-r">'+c.wr+'</div>';
        html+='</div>';
        html+='</td>';
      }
    }
    html+='</tr>';
  }

  // ã‚“ row
  var nChar=ROWS[9].chars[2]; // ã‚“
  html+='<tr><td class="row-label" style="background:var(--text-sub)">ã‚“</td>';
  for(var rk=rowKeys.length-1;rk>=0;rk--){
    if(rk===9){
      var learnedN=progress['ã‚“']?' learned':'';
      html+='<td class="chart-cell'+learnedN+'" data-kana="ã‚“">';
      html+='<div class="kana-area" onclick="event.stopPropagation();chartPlayKana(\'ã‚“\')">';
      html+='<div class="kana" style="color:'+ROWS[9].hex+'">ã‚“</div>';
      html+='<div class="roma'+(showRomaji?'':' hidden')+'">n</div>';
      html+='</div>';
      html+='<div class="word-area" onclick="event.stopPropagation();chartPlayWord(\'ã‚“\')">';
      html+='<img class="cell-img" src="../img/'+nChar.img+'?v3" alt="'+nChar.cn+'">';
      html+='<div class="word-text">'+nChar.word+'</div>';
      html+='<div class="word-r">'+nChar.wr+'</div>';
      html+='</div>';
      html+='</td>';
    }else{
      html+='<td class="chart-cell empty"></td>';
    }
  }
  html+='</tr>';

  // ã‚’ row
  var woChar=ROWS[9].chars[1]; // ã‚’
  html+='<tr><td class="row-label" style="background:var(--text-sub)">ã‚’</td>';
  for(var rk=rowKeys.length-1;rk>=0;rk--){
    if(rk===9){
      var learnedWo=progress['ã‚’']?' learned':'';
      html+='<td class="chart-cell'+learnedWo+'" data-kana="ã‚’">';
      html+='<div class="kana-area" onclick="event.stopPropagation();chartPlayKana(\'ã‚’\')">';
      html+='<div class="kana" style="color:'+ROWS[9].hex+'">ã‚’</div>';
      html+='<div class="roma'+(showRomaji?'':' hidden')+'">wo</div>';
      html+='</div>';
      html+='<div class="word-area" onclick="event.stopPropagation();chartPlayWord(\'ã‚’\')">';
      html+='<img class="cell-img" src="../img/'+woChar.img+'?v3" alt="'+woChar.cn+'">';
      html+='<div class="word-text">'+woChar.word+'</div>';
      html+='<div class="word-r">'+woChar.wr+'</div>';
      html+='</div>';
      html+='</td>';
    }else{
      html+='<td class="chart-cell empty"></td>';
    }
  }
  html+='</tr>';

  document.getElementById('chartTable').innerHTML=html;
}

function chartPlayKana(kana){
  speakJP(kana);
  markLearned(kana);
  highlightChartCell(kana);
}
function chartPlayWord(kana){
  var loc=KANA_MAP[kana];
  if(!loc)return;
  var c=ROWS[loc.ri].chars[loc.ci];
  speakJP(c.word);
  markLearned(kana);
  highlightChartCell(kana);
}
function highlightChartCell(kana){
  var cell=document.querySelector('#chartTable .chart-cell[data-kana="'+kana+'"]');
  if(!cell)return;
  cell.classList.add('playing');
  setTimeout(function(){cell.classList.remove('playing')},800);
}

// Play all chart
var chartPlaying=false;
function playAllChart(btn){
  if(chartPlaying){chartPlaying=false;btn.textContent='ğŸ”Š å…¨éƒ¨è¿æ’­';return}
  chartPlaying=true;
  btn.textContent='â¹ åœæ­¢';
  var all=[];
  ROWS.forEach(function(r){r.chars.forEach(function(c){all.push(c)})});
  var idx=0;
  function next(){
    if(!chartPlaying||idx>=all.length){
      chartPlaying=false;btn.textContent='ğŸ”Š å…¨éƒ¨è¿æ’­';
      document.querySelectorAll('#chartTable .chart-cell.playing').forEach(function(c){c.classList.remove('playing')});
      return;
    }
    var c=all[idx];
    document.querySelectorAll('#chartTable .chart-cell.playing').forEach(function(el){el.classList.remove('playing')});
    var cell=document.querySelector('#chartTable .chart-cell[data-kana="'+c.h+'"]');
    if(cell)cell.classList.add('playing');
    markLearned(c.h);
    idx++;
    speakJP(c.h,function(){
      setTimeout(function(){
        speakJP(c.word,function(){
          if(cell)cell.classList.remove('playing');
          setTimeout(next,300);
        });
      },200);
    });
  }
  next();
}

function resetProgress(){
  if(!confirm('ç¡®è®¤é‡ç½®æ‰€æœ‰å­¦ä¹ è¿›åº¦ï¼Ÿ'))return;
  progress={};
  localStorage.removeItem('gojuon_practice_progress');
  updateProgress();
  renderChart();
  renderCards(currentRow);
}

// ============================================================
// CARD RENDERING (single-face)
// ============================================================
function highlightSpecial(c){
  if(!c.special)return c.word;
  var parts=c.word.split(c.special);
  return parts.join('<span class="hl">'+c.special+'</span>');
}

function renderCards(filter){
  var container=document.getElementById('cardContainer');
  var html='';
  ROWS.forEach(function(row){
    if(filter&&filter!=='all'&&row.key!==filter)return;
    html+='<div class="row-header" style="background:'+row.color+'">'+row.name;
    html+=' <span style="font-size:11px;opacity:.8">('+row.chars.map(function(c){return c.r}).join(', ')+')</span>';
    html+='<button class="play-row-btn" onclick="playRow(event,\''+row.key+'\')">ğŸ”Š è¿æ’­</button>';
    html+='</div>';
    html+='<div class="card-grid">';
    row.chars.forEach(function(c){
      var learned=progress[c.h]?' learned':'';
      html+='<div class="pcard'+learned+'" data-kana="'+c.h+'">';
      // Top: kana
      html+='<div class="kana-top" onclick="cardPlayKana(\''+c.h+'\')">';
      html+='<span class="kana-speaker">ğŸ”Š</span>';
      html+='<div class="big-kana" style="color:'+row.color+'">'+c.h+'</div>';
      html+='<div class="romaji'+(showRomaji?'':' hidden')+'">'+c.r+'</div>';
      html+='</div>';
      // Bottom: word
      html+='<div class="word-bottom" onclick="cardPlayWord(\''+c.h+'\')">';
      html+='<img class="word-img" src="../img/'+c.img+'?v3" alt="'+c.cn+'">';
      html+='<div class="word-info">';
      html+='<div class="word-jp">'+highlightSpecial(c)+'</div>';
      html+='<div class="word-romaji'+(showRomaji?'':' hidden')+'">'+c.wr+'</div>';
      html+='<div class="word-cn">'+c.cn+'</div>';
      html+='</div>';
      html+='<span class="word-speaker">ğŸ”Š</span>';
      html+='</div>';
      html+='</div>';
    });
    html+='</div>';
  });
  container.innerHTML=html;
}

function cardPlayKana(kana){
  speakJP(kana);
  markLearned(kana);
  highlightCard(kana);
}
function cardPlayWord(kana){
  var loc=KANA_MAP[kana];
  if(!loc)return;
  var c=ROWS[loc.ri].chars[loc.ci];
  speakJP(c.word);
  markLearned(kana);
  highlightCard(kana);
}
function highlightCard(kana){
  var card=document.querySelector('#cardContainer .pcard[data-kana="'+kana+'"]');
  if(!card)return;
  card.classList.add('playing');
  setTimeout(function(){card.classList.remove('playing')},800);
}

// ============================================================
// ROMAJI TOGGLE
// ============================================================
function toggleRomaji(){
  showRomaji=document.getElementById('romajiToggle').checked;
  document.querySelectorAll('.romaji,.roma,.word-romaji').forEach(function(el){
    el.classList.toggle('hidden',!showRomaji);
  });
}

// ============================================================
// ROW TAB SWITCH
// ============================================================
function switchRow(key){
  currentRow=key;
  document.querySelectorAll('.row-tab').forEach(function(b){
    b.classList.toggle('active',b.getAttribute('data-key')===key);
  });
  renderCards(key);
}

// ============================================================
// PROGRESS
// ============================================================
function markLearned(kana){
  if(!progress[kana]){
    progress[kana]={date:Date.now()};
    localStorage.setItem('gojuon_practice_progress',JSON.stringify(progress));
    // Update card visual
    document.querySelectorAll('[data-kana="'+kana+'"]').forEach(function(el){
      el.classList.add('learned');
    });
    updateProgress();
  }
}
function updateProgress(){
  var total=0;
  ROWS.forEach(function(r){total+=r.chars.length});
  var learned=Object.keys(progress).length;
  document.getElementById('progFill').style.width=(learned/total*100)+'%';
  document.getElementById('progText').textContent=learned+'/'+total;
}

// ============================================================
// ROW PLAYBACK
// ============================================================
var playingRowFlag=false;
function playRow(event,rowKey){
  event.stopPropagation();
  if(playingRowFlag){playingRowFlag=false;return}
  var row=null;
  for(var i=0;i<ROWS.length;i++){if(ROWS[i].key===rowKey){row=ROWS[i];break}}
  if(!row)return;
  playingRowFlag=true;
  var idx=0;
  function next(){
    if(!playingRowFlag||idx>=row.chars.length){
      playingRowFlag=false;
      document.querySelectorAll('.pcard.playing').forEach(function(c){c.classList.remove('playing')});
      return;
    }
    var c=row.chars[idx];
    document.querySelectorAll('.pcard.playing').forEach(function(el){el.classList.remove('playing')});
    var card=document.querySelector('#cardContainer .pcard[data-kana="'+c.h+'"]');
    if(card){card.classList.add('playing');card.scrollIntoView({behavior:'smooth',block:'nearest'})}
    markLearned(c.h);
    idx++;
    speakJP(c.h,function(){
      setTimeout(function(){
        speakJP(c.word,function(){
          if(card)card.classList.remove('playing');
          setTimeout(next,300);
        });
      },200);
    });
  }
  next();
}

// ============================================================
// INIT
// ============================================================
renderChart();
renderCards('all');
updateProgress();
</script>
</body>
</html>
