<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>æ—ä¹‹æ’ äº”åéŸ³å›¾</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;600;700;900&family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#F5F0E8;--card-bg:#FFFEF9;--text:#2D2A24;--text-sub:#7A7468;
  --shadow:0 2px 20px rgba(45,42,36,.08);--r:20px;--rs:12px;
  --row-a:#E8573A;--row-ka:#2B7A98;--row-sa:#3A8F5C;--row-ta:#7B5EA7;
  --row-na:#D4903A;--row-ha:#2B8F8F;--row-ma:#D4557A;--row-ya:#B8860B;
  --row-ra:#4A90D9;--row-wa:#7A7468;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html{scroll-behavior:smooth}
body{font-family:'Noto Sans SC','M PLUS Rounded 1c',sans-serif;background:var(--bg);color:var(--text);line-height:1.6;overflow-x:hidden;min-height:100vh}

.header{position:relative;overflow:hidden;padding:32px 20px 24px;text-align:center;background:linear-gradient(135deg,#E8573A 0%,#D4553A 50%,#C04030 100%);color:#fff}
.header::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle at 30% 40%,rgba(255,255,255,.08) 0%,transparent 50%)}
.header h1{font-family:'M PLUS Rounded 1c','Noto Sans SC',sans-serif;font-size:26px;font-weight:900;letter-spacing:1px;text-shadow:0 2px 8px rgba(0,0,0,.2);position:relative}
.header .sub{font-size:13px;opacity:.8;margin-top:4px;position:relative}
.back-link{position:absolute;left:16px;top:16px;color:#fff;text-decoration:none;font-size:24px;opacity:.7;z-index:10}
.back-link:hover{opacity:1}

.mode-bar{display:flex;gap:8px;padding:12px 16px;justify-content:center;background:var(--bg);position:sticky;top:0;z-index:100}
.mode-btn{padding:8px 20px;border-radius:24px;border:2px solid #e0dcd4;font-size:14px;font-weight:700;cursor:pointer;background:#fff;color:var(--text-sub);transition:all .2s}
.mode-btn.active{background:var(--row-a);color:#fff;border-color:var(--row-a)}

.tab-nav{display:flex;gap:6px;padding:8px 16px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;position:sticky;top:52px;z-index:99;background:var(--bg)}
.tab-nav::-webkit-scrollbar{display:none}
.tab-btn{flex-shrink:0;padding:6px 14px;border-radius:20px;border:2px solid transparent;font-size:12px;font-weight:700;cursor:pointer;background:#fff;color:var(--text-sub);transition:all .2s;white-space:nowrap}
.tab-btn.active{color:#fff;border-color:transparent}

.progress-area{padding:8px 16px}
.progress-bar{height:6px;background:#e8e4dc;border-radius:3px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--row-a),var(--row-ka),var(--row-sa));border-radius:3px;transition:width .4s ease;width:0}
.progress-text{font-size:12px;color:var(--text-sub);text-align:center;margin-top:4px}

.section{display:none;padding:12px 16px 24px}
.section.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@keyframes bounce{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
@keyframes celebrate{0%{transform:scale(1)}50%{transform:scale(1.1) rotate(2deg)}100%{transform:scale(1)}}

/* === CHART VIEW === */
.chart-grid{display:grid;grid-template-columns:40px repeat(5,1fr);gap:4px;margin:12px 0}
.chart-header{font-size:11px;font-weight:700;color:var(--text-sub);text-align:center;padding:4px 0}
.chart-row-label{font-size:11px;font-weight:700;display:flex;align-items:center;justify-content:center;color:#fff;border-radius:8px;min-height:52px}
.chart-cell{background:var(--card-bg);border-radius:10px;padding:6px 4px;text-align:center;cursor:pointer;border:2px solid #f0ece4;transition:all .2s;min-height:52px;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative}
.chart-cell:active{transform:scale(.95)}
.chart-cell.playing{border-color:var(--row-a);box-shadow:0 0 0 2px var(--row-a)}
.chart-cell.learned::after{content:'âœ“';position:absolute;top:2px;right:4px;font-size:10px;color:#3A8F5C;font-weight:900}
.chart-cell .kana{font-family:'M PLUS Rounded 1c',sans-serif;font-size:22px;font-weight:900;line-height:1.2}
.chart-cell .roma{font-size:9px;color:var(--text-sub)}
.chart-cell.empty{background:transparent;border-color:transparent;cursor:default}

/* === ROW DETAIL VIEW === */
.row-section{margin:16px 0;animation:fadeIn .3s ease}
.row-header{font-size:18px;font-weight:900;padding:10px 16px;border-radius:var(--rs);color:#fff;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.row-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;margin-bottom:16px}
@media(min-width:600px){.row-cards{grid-template-columns:repeat(4,1fr)}}
@media(min-width:900px){.row-cards{grid-template-columns:repeat(5,1fr)}}

/* Single-face card (pcard vertical layout) */
.pcard{border-radius:var(--r);background:var(--card-bg);box-shadow:var(--shadow);border:2px solid #f0ece4;overflow:hidden;position:relative;transition:border-color .2s}
.pcard.playing{border-color:var(--row-a);box-shadow:0 0 0 3px var(--row-a),0 4px 20px rgba(232,87,58,.2)}
.pcard.learned::after{content:'\2713';position:absolute;top:8px;left:10px;font-size:14px;color:#3A8F5C;font-weight:900;z-index:2}

/* Top: kana area */
.kana-top{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:14px 8px 10px;cursor:pointer;transition:background .15s;position:relative;border-bottom:1px dashed #f0ece4}
.kana-top:active{background:rgba(232,87,58,.08)}
.kana-top .big-kana{font-family:'M PLUS Rounded 1c',sans-serif;font-size:48px;font-weight:900;line-height:1}
.kana-top .sub-kana{font-size:16px;color:var(--text-sub);margin-top:2px}
.kana-top .romaji{font-size:14px;font-weight:700;color:var(--row-a);margin-top:2px}
.kana-top .kana-speaker{position:absolute;top:8px;right:8px;font-size:14px;opacity:.5}

/* Bottom: word area (vertical: image on top, text below) */
.word-bottom{display:flex;flex-direction:column;align-items:center;padding:10px 12px;cursor:pointer;transition:background .15s;position:relative}
.word-bottom:active{background:rgba(232,87,58,.08)}
.word-bottom .word-img{width:100%;max-width:120px;aspect-ratio:1;object-fit:contain;border-radius:8px;display:block;margin:0 auto}
.word-bottom .word-info{text-align:center;margin-top:6px}
.word-bottom .word-jp{font-family:'M PLUS Rounded 1c',sans-serif;font-size:18px;font-weight:900;line-height:1.2}
.word-bottom .word-cn{font-size:13px;color:var(--text-sub);font-weight:600}
.word-bottom .word-speaker{position:absolute;top:8px;right:8px;font-size:14px;opacity:.5}

.mnemonic{font-size:11px;color:var(--text-sub);padding:4px 12px 8px;text-align:center;font-style:italic}

@media(max-width:400px){
  .kana-top .big-kana{font-size:38px}
  .word-bottom .word-jp{font-size:16px}
}

/* === QUIZ === */
.quiz-box{background:var(--card-bg);border-radius:var(--r);padding:24px 16px;margin:16px 0;box-shadow:var(--shadow);text-align:center}
.quiz-prompt{font-family:'M PLUS Rounded 1c',sans-serif;font-size:56px;font-weight:900;margin:16px 0}
.quiz-prompt.small{font-size:20px;font-weight:700;color:var(--text-sub)}
.quiz-options{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:16px 0}
.quiz-opt{padding:14px;border-radius:var(--rs);border:2px solid #e8e4dc;background:#fff;font-size:18px;font-weight:700;cursor:pointer;transition:all .2s}
.quiz-opt:active{transform:scale(.95)}
.quiz-opt.correct{background:#d4edda;border-color:#3A8F5C;color:#3A8F5C}
.quiz-opt.wrong{background:#f8d7da;border-color:#C04030;color:#C04030}
.quiz-score{font-size:16px;font-weight:700;margin:12px 0}
.quiz-btn{padding:10px 24px;border-radius:24px;border:none;font-size:14px;font-weight:700;cursor:pointer;color:#fff;background:var(--row-a);transition:all .2s;margin:4px}
.quiz-btn:active{transform:scale(.95)}
.quiz-btn.secondary{background:var(--row-ka)}

.home-btn{text-align:center;padding:20px 16px}
.home-btn a{display:inline-block;padding:12px 32px;border-radius:24px;background:var(--row-a);color:#fff;text-decoration:none;font-weight:700;font-size:15px;box-shadow:0 2px 12px rgba(0,0,0,.1)}
</style>
</head>
<body>

<div class="header">
  <a class="back-link" href="../index.html">&#8592;</a>
  <h1>ğŸŒ äº”åéŸ³å›¾ ã”ã˜ã‚…ã†ãŠã‚“</h1>
  <div class="sub">ç‚¹å‡»å‡åå¬å‘éŸ³ Â· å·¦å³æ»‘åŠ¨åˆ‡æ¢</div>
</div>

<div class="mode-bar">
  <button class="mode-btn active" onclick="setMode('hira')">ã²ã‚‰ãŒãª</button>
  <button class="mode-btn" onclick="setMode('kata')">ã‚«ã‚¿ã‚«ãƒŠ</button>
  <button class="mode-btn" onclick="setMode('both')">ä¸¡æ–¹</button>
</div>
<div class="mode-bar" style="padding-top:0;gap:6px">
  <span style="font-size:12px;color:var(--text-sub);align-self:center">å‘éŸ³:</span>
  <button class="mode-btn voice-btn active" onclick="setVoice('tts')" style="padding:6px 14px;font-size:12px">AIè¯­éŸ³</button>
  <button class="mode-btn voice-btn" onclick="setVoice('human')" style="padding:6px 14px;font-size:12px">çœŸäººå½•éŸ³</button>
</div>

<nav class="tab-nav" id="tabNav">
  <button class="tab-btn active" data-sec="0" onclick="switchTab(0)" style="background:var(--row-a);color:#fff">äº”åéŸ³è¡¨</button>
  <button class="tab-btn" data-sec="1" onclick="switchTab(1)">ã‚è¡Œ</button>
  <button class="tab-btn" data-sec="2" onclick="switchTab(2)">ã‹è¡Œ</button>
  <button class="tab-btn" data-sec="3" onclick="switchTab(3)">ã•è¡Œ</button>
  <button class="tab-btn" data-sec="4" onclick="switchTab(4)">ãŸè¡Œ</button>
  <button class="tab-btn" data-sec="5" onclick="switchTab(5)">ãªè¡Œ</button>
  <button class="tab-btn" data-sec="6" onclick="switchTab(6)">ã¯è¡Œ</button>
  <button class="tab-btn" data-sec="7" onclick="switchTab(7)">ã¾è¡Œ</button>
  <button class="tab-btn" data-sec="8" onclick="switchTab(8)">ã‚„è¡Œ</button>
  <button class="tab-btn" data-sec="9" onclick="switchTab(9)">ã‚‰è¡Œ</button>
  <button class="tab-btn" data-sec="10" onclick="switchTab(10)">ã‚è¡Œ</button>
  <button class="tab-btn" data-sec="11" onclick="switchTab(11)">ğŸ® æµ‹éªŒ</button>
</nav>

<div class="progress-area">
  <div class="progress-bar"><div class="progress-fill" id="progFill"></div></div>
  <div class="progress-text" id="progText">å·²å­¦ä¹  0/46 ä¸ªå‡å</div>
</div>

<!-- SEC 0: Full Chart -->
<div class="section active" id="sec0"></div>

<!-- SEC 1-10: Row details (generated by JS) -->
<div class="section" id="sec1"></div>
<div class="section" id="sec2"></div>
<div class="section" id="sec3"></div>
<div class="section" id="sec4"></div>
<div class="section" id="sec5"></div>
<div class="section" id="sec6"></div>
<div class="section" id="sec7"></div>
<div class="section" id="sec8"></div>
<div class="section" id="sec9"></div>
<div class="section" id="sec10"></div>

<!-- SEC 11: Quiz -->
<div class="section" id="sec11">
  <div class="quiz-box" id="quizBox">
    <div style="font-size:18px;font-weight:700;margin-bottom:16px">äº”åéŸ³æµ‹éªŒ</div>
    <p style="color:var(--text-sub);margin-bottom:16px">é€‰æ‹©æµ‹éªŒç±»å‹å¼€å§‹ç»ƒä¹ </p>
    <button class="quiz-btn" onclick="startQuiz('listen')">ğŸ”Š å¬éŸ³é€‰å­—</button>
    <button class="quiz-btn secondary" onclick="startQuiz('read')">ğŸ‘€ çœ‹å­—é€‰éŸ³</button>
    <button class="quiz-btn" style="background:var(--row-sa)" onclick="startQuiz('word')">ğŸ¯ å•è¯é¦–å­—</button>
  </div>
</div>

<!-- YouTube Videos -->
<div style="padding:12px 16px">
  <div style="font-size:18px;font-weight:900;margin-bottom:12px">ğŸ¬ æ¨èè§†é¢‘</div>
  <div style="display:grid;gap:12px">
    <div style="background:var(--card-bg);border-radius:var(--r);padding:12px;box-shadow:var(--shadow)">
      <div style="font-weight:700;margin-bottom:6px">ğŸµ ã‚ã„ã†ãˆãŠã®ã†ãŸ (AIUEO Song)</div>
      <div style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:12px">
        <iframe style="position:absolute;top:0;left:0;width:100%;height:100%;border:none" src="https://www.youtube.com/embed/plvSpVSdJWU" allowfullscreen loading="lazy"></iframe>
      </div>
    </div>
    <div style="background:var(--card-bg);border-radius:var(--r);padding:12px;box-shadow:var(--shadow)">
      <div style="font-weight:700;margin-bottom:6px">âœï¸ Learn Hiragana fast in 3 minutes</div>
      <div style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:12px">
        <iframe style="position:absolute;top:0;left:0;width:100%;height:100%;border:none" src="https://www.youtube.com/embed/2qk4gCZuSjk" allowfullscreen loading="lazy"></iframe>
      </div>
    </div>
    <div style="background:var(--card-bg);border-radius:var(--r);padding:12px;box-shadow:var(--shadow)">
      <div style="font-weight:700;margin-bottom:6px">ğŸŒ ã—ã¾ã˜ã‚ã† ã²ã‚‰ãŒãªã®ã†ãŸ</div>
      <div style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:12px">
        <iframe style="position:absolute;top:0;left:0;width:100%;height:100%;border:none" src="https://www.youtube.com/embed/8IpHIUxhdaI" allowfullscreen loading="lazy"></iframe>
      </div>
    </div>
    <div style="background:var(--card-bg);border-radius:var(--r);padding:12px;box-shadow:var(--shadow)">
      <div style="font-weight:700;margin-bottom:6px">ğŸŒ ã‚«ã‚¿ã‚«ãƒŠ ã‚ã„ã†ãˆãŠã®ã†ãŸ</div>
      <div style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:12px">
        <iframe style="position:absolute;top:0;left:0;width:100%;height:100%;border:none" src="https://www.youtube.com/embed/pMJKwfm0o6s" allowfullscreen loading="lazy"></iframe>
      </div>
    </div>
  </div>
</div>

<div class="home-btn">
  <a href="../index.html">&#8592; è¿”å›è¯¾ç¨‹åˆ—è¡¨</a>
</div>

<script src="../scripts/audio.js"></script>
<script src="../scripts/cache-control.js"></script>
<script src="../scripts/emoji-data.js"></script>
<script>
// ============================================================
// DATA
// ============================================================
var ROWS = [
  {name:'ã‚è¡Œ',color:'var(--row-a)',hex:'#E8573A',chars:[
    {h:'ã‚',k:'ã‚¢',r:'a',word:'ã‚ã‚Š',cn:'èš‚èš',img:'ant.png',memo:'å¼ å¼€å˜´è¯´ a!'},
    {h:'ã„',k:'ã‚¤',r:'i',word:'ã„ã¬',cn:'ç‹—',img:'dog.png',memo:'ä¸¤æ¡çº¿åƒè¯´ i'},
    {h:'ã†',k:'ã‚¦',r:'u',word:'ã†ã•ã',cn:'å…”å­',img:'rabbit.png',memo:'å˜´å·´å˜Ÿèµ·æ¥ u'},
    {h:'ãˆ',k:'ã‚¨',r:'e',word:'ãˆã³',cn:'è™¾',img:'shrimp.png',memo:'åƒä¸€åªè™¾å¼¯ç€èº«ä½“'},
    {h:'ãŠ',k:'ã‚ª',r:'o',word:'ãŠã•ã‹ãª',cn:'é±¼',img:'fish.png',memo:'åœ†åœ†çš„å˜´è¯´ o'}
  ]},
  {name:'ã‹è¡Œ',color:'var(--row-ka)',hex:'#2B7A98',chars:[
    {h:'ã‹',k:'ã‚«',r:'ka',word:'ã‹ã«',cn:'èƒèŸ¹',img:'crab.png',memo:'åŠ›æ°”å¤§çš„èƒèŸ¹ ka!'},
    {h:'ã',k:'ã‚­',r:'ki',word:'ãã‚Šã‚“',cn:'é•¿é¢ˆé¹¿',img:'giraffe.png',memo:'åƒä¸€æŠŠé’¥åŒ™ key'},
    {h:'ã',k:'ã‚¯',r:'ku',word:'ãã˜ã‚‰',cn:'é²¸é±¼',img:'whale.png',memo:'å˜´å·´å¼ å¼€ ku'},
    {h:'ã‘',k:'ã‚±',r:'ke',word:'ã‘ã‚€ã—',cn:'æ¯›æ¯›è™«',img:'bug.png',memo:'æ¯›æ¯›è™«åœ¨çˆ¬'},
    {h:'ã“',k:'ã‚³',r:'ko',word:'ã“ã¨ã‚Š',cn:'å°é¸Ÿ',img:'bird.png',memo:'ä¸¤æ¡æ¨ªçº¿åƒå˜´å·´'}
  ]},
  {name:'ã•è¡Œ',color:'var(--row-sa)',hex:'#3A8F5C',chars:[
    {h:'ã•',k:'ã‚µ',r:'sa',word:'ã•ã‹ãª',cn:'é±¼',img:'fish.png',memo:'åƒé±¼åœ¨æ¸¸æ³³ sa~'},
    {h:'ã—',k:'ã‚·',r:'shi',word:'ã—ã‹',cn:'é¹¿',img:'deer.png',memo:'åƒä¸€ä¸ªé±¼é’©'},
    {h:'ã™',k:'ã‚¹',r:'su',word:'ã™ã—',cn:'å¯¿å¸',img:'sushi.png',memo:'å¯¿å¸å¥½åƒ su!'},
    {h:'ã›',k:'ã‚»',r:'se',word:'ã›ã‚“ã‚',cn:'é“è·¯',img:'shinkansen.png',memo:'æ–°å¹²çº¿é£é©°'},
    {h:'ã',k:'ã‚½',r:'so',word:'ãã‚‰',cn:'å¤©ç©º',img:'rainbow.png',memo:'å½©è™¹åœ¨å¤©ç©º so beautiful'}
  ]},
  {name:'ãŸè¡Œ',color:'var(--row-ta)',hex:'#7B5EA7',chars:[
    {h:'ãŸ',k:'ã‚¿',r:'ta',word:'ãŸã“',cn:'ç« é±¼',img:'squid.png',memo:'åƒä¸€ä¸ªåå­—æ¶ ta'},
    {h:'ã¡',k:'ãƒ',r:'chi',word:'ã¡ã‚‡ã†',cn:'è´è¶',img:'butterfly.png',memo:'è´è¶ç¿©ç¿©é£ chi~'},
    {h:'ã¤',k:'ãƒ„',r:'tsu',word:'ã¤ã',cn:'æœˆäº®',img:'star.png',memo:'åƒä¸€ä¸ªå¾®ç¬‘ tsu'},
    {h:'ã¦',k:'ãƒ†',r:'te',word:'ã¦ã‚“ã¨ã†',cn:'ç“¢è™«',img:'ladybug.png',memo:'ä¼¸å‡ºæ‰‹ te'},
    {h:'ã¨',k:'ãƒˆ',r:'to',word:'ã¨ã‚Š',cn:'é¸Ÿ',img:'eagle.png',memo:'é¸Ÿå„¿é£ to~'}
  ]},
  {name:'ãªè¡Œ',color:'var(--row-na)',hex:'#D4903A',chars:[
    {h:'ãª',k:'ãƒŠ',r:'na',word:'ãªã¾ã‘ã‚‚ã®',cn:'æ ‘æ‡’',img:'sloth.png',memo:'æ…¢åå na~'},
    {h:'ã«',k:'ãƒ‹',r:'ni',word:'ã«ã‚ã¨ã‚Š',cn:'å…¬é¸¡',img:'rooster.png',memo:'å…¬é¸¡å« ni!'},
    {h:'ã¬',k:'ãƒŒ',r:'nu',word:'ã¬ã„ãã‚‹ã¿',cn:'æ¯›ç»’ç©å…·',img:'bear.png',memo:'æŠ±ç€ç©å…· nu'},
    {h:'ã­',k:'ãƒ',r:'ne',word:'ã­ã“',cn:'çŒ«',img:'cat.png',memo:'çŒ«å’ªå« ne~'},
    {h:'ã®',k:'ãƒ',r:'no',word:'ã®ã†ã•ã',cn:'é‡å…”',img:'rabbit2.png',memo:'åƒä¸€ä¸ªæ—‹æ¶¡ no'}
  ]},
  {name:'ã¯è¡Œ',color:'var(--row-ha)',hex:'#2B8F8F',chars:[
    {h:'ã¯',k:'ãƒ',r:'ha',word:'ã¯ã¡',cn:'èœœèœ‚',img:'bee.png',memo:'èœœèœ‚å—¡å—¡ ha~'},
    {h:'ã²',k:'ãƒ’',r:'hi',word:'ã²ã¤ã˜',cn:'ç»µç¾Š',img:'sheep.png',memo:'ç»µç¾Šå’©å’© hi'},
    {h:'ãµ',k:'ãƒ•',r:'fu',word:'ãµã­',cn:'èˆ¹',img:'ship.png',memo:'èˆ¹åœ¨æµ·ä¸Š fu~'},
    {h:'ã¸',k:'ãƒ˜',r:'he',word:'ã¸ã³',cn:'è›‡',img:'snake.png',memo:'åƒä¸€åº§å°å±± he'},
    {h:'ã»',k:'ãƒ›',r:'ho',word:'ã»ã—',cn:'æ˜Ÿæ˜Ÿ',img:'star.png',memo:'æ˜Ÿæ˜Ÿé—ªé—ª ho!'}
  ]},
  {name:'ã¾è¡Œ',color:'var(--row-ma)',hex:'#D4557A',chars:[
    {h:'ã¾',k:'ãƒ',r:'ma',word:'ã†ã¾',cn:'é©¬',img:'horse.png',memo:'å¦ˆå¦ˆ mama!'},
    {h:'ã¿',k:'ãƒŸ',r:'mi',word:'ã¿ã¿',cn:'è€³æœµ',img:'ear.png',memo:'ä¸‰æ¡çº¿åƒè€³æœµ mi'},
    {h:'ã‚€',k:'ãƒ ',r:'mu',word:'ã‚€ã—',cn:'è™«å­',img:'bug.png',memo:'è™«å­åœ¨çˆ¬ mu~'},
    {h:'ã‚',k:'ãƒ¡',r:'me',word:'ã‚ã ã‹',cn:'é’é³‰é±¼',img:'tropical_fish.png',memo:'çœ¼ç› me'},
    {h:'ã‚‚',k:'ãƒ¢',r:'mo',word:'ã‚‚ã‚‚',cn:'æ¡ƒå­',img:'apple.png',memo:'æ¡ƒå­å¥½åƒ mo~'}
  ]},
  {name:'ã‚„è¡Œ',color:'var(--row-ya)',hex:'#B8860B',chars:[
    {h:'ã‚„',k:'ãƒ¤',r:'ya',word:'ã‚„ã',cn:'å±±ç¾Š',img:'ram.png',memo:'å±±ç¾Šå« ya!'},
    {h:'ã‚†',k:'ãƒ¦',r:'yu',word:'ã‚†ã',cn:'é›ª',img:'snowflake.png',memo:'é›ªèŠ±é£˜ yu~'},
    {h:'ã‚ˆ',k:'ãƒ¨',r:'yo',word:'ã‚ˆã‚‹',cn:'å¤œæ™š',img:'owl.png',memo:'çŒ«å¤´é¹° yo!'}
  ]},
  {name:'ã‚‰è¡Œ',color:'var(--row-ra)',hex:'#4A90D9',chars:[
    {h:'ã‚‰',k:'ãƒ©',r:'ra',word:'ã‚‰ãã ',cn:'éª†é©¼',img:'camel.png',memo:'éª†é©¼èµ°æ²™æ¼  ra~'},
    {h:'ã‚Š',k:'ãƒª',r:'ri',word:'ã‚Šã™',cn:'æ¾é¼ ',img:'squirrel.png',memo:'æ¾é¼ åƒåšæœ ri'},
    {h:'ã‚‹',k:'ãƒ«',r:'ru',word:'ã‚‹ã™',cn:'ä¸åœ¨å®¶',img:'house.png',memo:'å®¶é‡Œæ²¡äºº ru'},
    {h:'ã‚Œ',k:'ãƒ¬',r:'re',word:'ã‚Œã‚“ã“ã‚“',cn:'è²è—•',img:'sakura.png',memo:'è²èŠ±ç››å¼€ re'},
    {h:'ã‚',k:'ãƒ­',r:'ro',word:'ã‚ã°',cn:'é©´',img:'horse.png',memo:'é©´å­èµ°è·¯ ro~'}
  ]},
  {name:'ã‚è¡Œ',color:'var(--row-wa)',hex:'#7A7468',chars:[
    {h:'ã‚',k:'ãƒ¯',r:'wa',word:'ã‚ã«',cn:'é³„é±¼',img:'crocodile.png',memo:'é³„é±¼å¼ å˜´ wa!'},
    {h:'ã‚’',k:'ãƒ²',r:'wo',word:'(åŠ©è¯)',cn:'åŠ©è¯',img:'book.png',memo:'å¥å­é‡Œå¸¸ç”¨çš„åŠ©è¯'},
    {h:'ã‚“',k:'ãƒ³',r:'n',word:'ã¿ã‹ã‚“',cn:'æ©˜å­',img:'orange.png',memo:'é¼»å­å“¼ n~'}
  ]}
];

var mode='hira'; // hira, kata, both
var activeTab=0;
var progress=JSON.parse(localStorage.getItem('gojuon_progress')||'{}');

// Voice mode: 'tts' (Edge Neural TTS) or 'human' (real recording)
var voiceMode=localStorage.getItem('gojuon_voice')||'tts';
// Human voice audio map (hv_ prefixed files)
var humanAudioMap={};
(function(){
  var kanaList='ã‚ã„ã†ãˆãŠã‹ããã‘ã“ã•ã—ã™ã›ããŸã¡ã¤ã¦ã¨ãªã«ã¬ã­ã®ã¯ã²ãµã¸ã»ã¾ã¿ã‚€ã‚ã‚‚ã‚„ã‚†ã‚ˆã‚‰ã‚Šã‚‹ã‚Œã‚ã‚ã‚’ã‚“';
  for(var i=0;i<kanaList.length;i++){
    var k=kanaList[i];
    // Compute MD5 hash to get filename (matches server-side generation)
    // We pre-compute the mapping here
    humanAudioMap[k]=null; // will be filled from pre-computed map below
  }
  // Pre-computed kana â†’ hv_ filename mapping
  var hvMap={"ã‚":"hv_8c0c3027e3cf.mp3","ã„":"hv_655dcb0e6519.mp3","ã†":"hv_31e55ff7f86a.mp3","ãˆ":"hv_456505723301.mp3","ãŠ":"hv_1cfa7b2136e3.mp3","ã‹":"hv_b19ca85e627a.mp3","ã":"hv_02485a52b7c7.mp3","ã":"hv_d9d3327f0d6b.mp3","ã‘":"hv_fbd0909bdc60.mp3","ã“":"hv_9b9b7e95c6d3.mp3","ã•":"hv_880beff92bce.mp3","ã—":"hv_fc0e89edd800.mp3","ã™":"hv_052cd511c8cd.mp3","ã›":"hv_18f507c55c1f.mp3","ã":"hv_2d5f27ce2f0f.mp3","ãŸ":"hv_14cc9288ee62.mp3","ã¡":"hv_033547bb3379.mp3","ã¤":"hv_38332eba4797.mp3","ã¦":"hv_66b6491143c9.mp3","ã¨":"hv_a5401f0cb256.mp3","ãª":"hv_2b8cb2efd8ab.mp3","ã«":"hv_8b63626ad336.mp3","ã¬":"hv_0240ca37aa8a.mp3","ã­":"hv_448d36c51ab4.mp3","ã®":"hv_359ebee169e2.mp3","ã¯":"hv_b7a83b3be2f3.mp3","ã²":"hv_c89b06a70bca.mp3","ãµ":"hv_ab8c953c8926.mp3","ã¸":"hv_40346ed000e4.mp3","ã»":"hv_4b77b80010ac.mp3","ã¾":"hv_f25fb3210b65.mp3","ã¿":"hv_810c1371789a.mp3","ã‚€":"hv_08f736b4e1dd.mp3","ã‚":"hv_9f7031cd04b5.mp3","ã‚‚":"hv_ac50f83054ad.mp3","ã‚„":"hv_3cb21c442c12.mp3","ã‚†":"hv_31c8f22ffa33.mp3","ã‚ˆ":"hv_66cb79a0064b.mp3","ã‚‰":"hv_fa887b39a3ee.mp3","ã‚Š":"hv_0e8f23d1bc9e.mp3","ã‚‹":"hv_c1dbaa16c4d9.mp3","ã‚Œ":"hv_2573123cacb2.mp3","ã‚":"hv_6d338062aaf8.mp3","ã‚":"hv_95ae7ce6fb03.mp3","ã‚’":"hv_96ac23a7525c.mp3","ã‚“":"hv_8a9f198246c5.mp3"};
  for(var k in hvMap){
    humanAudioMap[k]='../audio/'+hvMap[k];
  }
})();
// Override speakJP for human voice mode
var _origSpeakJP=null;
function speakKana(text,cb){
  if(voiceMode==='human' && humanAudioMap[text]){
    // Play human voice MP3 directly
    var a=new Audio(humanAudioMap[text]);
    if(window.currentAudio){try{window.currentAudio.pause()}catch(e){}}
    if(window.speechSynthesis)window.speechSynthesis.cancel();
    window.currentAudio=a;
    a.onended=function(){window.currentAudio=null;if(cb)cb()};
    a.onerror=function(){window.currentAudio=null;speakJP(text,cb)};
    a.play().catch(function(){window.currentAudio=null;speakJP(text,cb)});
  } else {
    speakJP(text,cb);
  }
}

// Audio is now handled by shared ../scripts/audio.js
// which loads data/audio-map.json with high-quality kana MP3 files

// ============================================================
// MODE TOGGLE
// ============================================================
function setMode(m){
  mode=m;
  document.querySelectorAll('.mode-btn:not(.voice-btn)').forEach(function(b,i){
    b.classList.toggle('active',['hira','kata','both'][i]===m);
  });
  renderAll();
}

function setVoice(v){
  voiceMode=v;
  localStorage.setItem('gojuon_voice',v);
  document.querySelectorAll('.voice-btn').forEach(function(b,i){
    b.classList.toggle('active',['tts','human'][i]===v);
  });
}

// ============================================================
// TAB SWITCHING
// ============================================================
var tabColors=['var(--row-a)','var(--row-a)','var(--row-ka)','var(--row-sa)','var(--row-ta)','var(--row-na)','var(--row-ha)','var(--row-ma)','var(--row-ya)','var(--row-ra)','var(--row-wa)','var(--row-a)'];
function switchTab(i){
  activeTab=i;
  document.querySelectorAll('.tab-btn').forEach(function(b,idx){
    var isActive=idx===i;
    b.classList.toggle('active',isActive);
    if(isActive){b.style.background=tabColors[idx];b.style.color='#fff'}
    else{b.style.background='#fff';b.style.color='var(--text-sub)'}
  });
  document.querySelectorAll('.section').forEach(function(s,idx){
    s.classList.toggle('active',idx===i);
  });
  // Scroll tab into view
  var btn=document.querySelectorAll('.tab-btn')[i];
  if(btn)btn.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'});
}

// Swipe
var tx=0;
document.addEventListener('touchstart',function(e){tx=e.changedTouches[0].screenX},{passive:true});
document.addEventListener('touchend',function(e){
  var d=tx-e.changedTouches[0].screenX;
  if(Math.abs(d)>60){var n=activeTab+(d>0?1:-1);if(n>=0&&n<=11)switchTab(n)}
},{passive:true});

// ============================================================
// RENDER
// ============================================================
function getDisplay(c){
  if(mode==='hira')return c.h;
  if(mode==='kata')return c.k;
  return c.h+'<span style="font-size:.5em;color:var(--text-sub);display:block">'+c.k+'</span>';
}

function renderChart(){
  var sec=document.getElementById('sec0');
  var html='<div class="chart-grid">';
  // Header row
  html+='<div class="chart-header"></div>';
  ['ã‚æ®µ','ã„æ®µ','ã†æ®µ','ãˆæ®µ','ãŠæ®µ'].forEach(function(h){
    html+='<div class="chart-header">'+h+'</div>';
  });
  // Data rows
  ROWS.forEach(function(row){
    html+='<div class="chart-row-label" style="background:'+row.color+'">'+row.name.charAt(0)+'</div>';
    var cols=[null,null,null,null,null];
    row.chars.forEach(function(c){
      var vi='aiueo'.indexOf(c.r.slice(-1));
      // Handle special cases
      if(c.r==='shi')vi=1;
      if(c.r==='chi')vi=1;
      if(c.r==='tsu')vi=2;
      if(c.r==='fu')vi=2;
      if(c.r==='ya')vi=0;
      if(c.r==='yu')vi=2;
      if(c.r==='yo')vi=4;
      if(c.r==='wa')vi=0;
      if(c.r==='wo')vi=4;
      if(c.r==='n')vi=0;
      cols[vi]=c;
    });
    cols.forEach(function(c,ci){
      if(c){
        var learned=progress[c.h]?'learned':'';
        html+='<div class="chart-cell '+learned+'" onclick="playChart(this,\''+c.h+'\',\''+c.r+'\')" data-kana="'+c.h+'">';
        html+='<div class="kana">'+getDisplay(c)+'</div>';
        html+='<div class="roma">'+c.r+'</div>';
        html+='</div>';
      }else{
        html+='<div class="chart-cell empty"></div>';
      }
    });
  });
  html+='</div>';
  sec.innerHTML=html;
}

function playChart(el,kana,roma){
  document.querySelectorAll('.chart-cell.playing').forEach(function(c){c.classList.remove('playing')});
  el.classList.add('playing');
  el.style.animation='bounce .3s ease';
  setTimeout(function(){el.style.animation=''},300);
  speakKana(kana,function(){el.classList.remove('playing')});
  // Mark as learned
  if(!progress[kana]){
    progress[kana]={date:Date.now()};
    localStorage.setItem('gojuon_progress',JSON.stringify(progress));
    el.classList.add('learned');
    updateProgress();
  }
}

function renderRowDetail(rowIdx){
  var row=ROWS[rowIdx];
  var sec=document.getElementById('sec'+(rowIdx+1));
  var html='<div class="row-section">';
  html+='<div class="row-header" style="background:'+row.color+'">'+row.name+' ('+row.chars.map(function(c){return c.r}).join(', ')+')</div>';
  html+='<div class="row-cards">';
  row.chars.forEach(function(c){
    var learned=progress[c.h]?' learned':'';
    html+='<div class="pcard'+learned+'" data-kana="'+c.h+'">';
    // Top: kana
    html+='<div class="kana-top" onclick="playCardKana(this.parentNode,\''+c.h+'\')">';
    html+='<span class="kana-speaker">ğŸ”Š</span>';
    html+='<div class="big-kana">'+getDisplay(c)+'</div>';
    if(mode!=='both')html+='<div class="sub-kana">'+(mode==='hira'?c.k:c.h)+'</div>';
    html+='<div class="romaji" style="color:'+row.color+'">'+c.r+'</div>';
    html+='</div>';
    // Bottom: word (vertical layout)
    html+='<div class="word-bottom" onclick="playCardWord(this.parentNode,\''+c.word+'\')">';
    html+='<img class="word-img" src="../img/'+c.img+'" alt="'+c.cn+'">';
    html+='<div class="word-info"><div class="word-jp">'+c.word+'</div><div class="word-cn">'+c.cn+'</div></div>';
    html+='<span class="word-speaker">ğŸ”Š</span>';
    html+='</div>';
    html+='<div class="mnemonic">ğŸ’¡ '+c.memo+'</div>';
    html+='</div>';
  });
  html+='</div>';
  html+='<div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">';
  html+='<button class="quiz-btn" style="background:'+row.color+'" onclick="playRow('+rowIdx+',this)">ğŸ”Š è¿ç»­æ’­æ”¾</button>';
  html+='<button class="quiz-btn" style="background:'+row.color+'" onclick="startRowQuiz('+rowIdx+')">ç»ƒä¹  '+row.name+'</button>';
  html+='</div>';
  html+='</div>';
  sec.innerHTML=html;
}

function playCardKana(el,kana){
  document.querySelectorAll('.pcard.playing').forEach(function(c){c.classList.remove('playing')});
  el.classList.add('playing');
  speakKana(kana,function(){el.classList.remove('playing')});
  if(!progress[kana]){
    progress[kana]={date:Date.now()};
    localStorage.setItem('gojuon_progress',JSON.stringify(progress));
    el.classList.add('learned');
    updateProgress();
  }
}

function playCardWord(el,word){
  document.querySelectorAll('.pcard.playing').forEach(function(c){c.classList.remove('playing')});
  el.classList.add('playing');
  speakJP(word,function(){el.classList.remove('playing')});
}

// Play all kana in a row sequentially
var playingRow=false;
function playRow(rowIdx,btn){
  if(playingRow){playingRow=false;return}
  var row=ROWS[rowIdx];
  var chars=row.chars;
  playingRow=true;
  if(btn){btn.textContent='â¹ åœæ­¢';btn.style.opacity='0.7'}
  var i=0;
  var cards=document.querySelectorAll('#sec'+(rowIdx+1)+' .pcard');
  function next(){
    if(!playingRow||i>=chars.length){
      playingRow=false;
      cards.forEach(function(cd){cd.classList.remove('playing');cd.style.transform='';cd.style.zIndex=''});
      if(btn){btn.textContent='ğŸ”Š è¿ç»­æ’­æ”¾';btn.style.opacity='1'}
      return;
    }
    var c=chars[i];
    // Reset all cards
    cards.forEach(function(cd){cd.classList.remove('playing');cd.style.transform='';cd.style.zIndex=''});
    // Highlight current card: scale up + border
    if(cards[i]){
      cards[i].classList.add('playing');
      cards[i].style.transform='scale(1.08)';
      cards[i].style.zIndex='10';
      cards[i].scrollIntoView({behavior:'smooth',block:'nearest'});
    }
    i++;
    speakKana(c.h,function(){
      setTimeout(function(){
        // Also play the example word after the kana
        speakJP(c.word,function(){
          setTimeout(next,300);
        });
      },200);
    });
  }
  next();
}

function updateProgress(){
  var total=0;
  ROWS.forEach(function(r){total+=r.chars.length});
  var learned=Object.keys(progress).length;
  document.getElementById('progFill').style.width=(learned/total*100)+'%';
  document.getElementById('progText').textContent='å·²å­¦ä¹  '+learned+'/'+total+' ä¸ªå‡å';
}

function renderAll(){
  renderChart();
  for(var i=0;i<ROWS.length;i++)renderRowDetail(i);
  updateProgress();
}

// ============================================================
// QUIZ
// ============================================================
var quizMode='',quizData=[],quizIdx=0,quizScore=0,quizTotal=10,quizRowIdx=-1;

function getAllChars(){
  var all=[];
  ROWS.forEach(function(r){r.chars.forEach(function(c){all.push(c)})});
  return all;
}

function shuffle(arr){
  for(var i=arr.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=arr[i];arr[i]=arr[j];arr[j]=t}
  return arr;
}

function startQuiz(type){
  quizMode=type;quizIdx=0;quizScore=0;quizRowIdx=-1;
  quizData=shuffle(getAllChars().slice()).slice(0,quizTotal);
  showQuizQ();
}

function startRowQuiz(ri){
  quizMode='listen';quizIdx=0;quizScore=0;quizRowIdx=ri;
  quizData=shuffle(ROWS[ri].chars.slice());
  quizTotal=quizData.length;
  switchTab(11);
  showQuizQ();
}

function showQuizQ(){
  if(quizIdx>=quizData.length){showQuizResult();return}
  var c=quizData[quizIdx];
  var all=quizRowIdx>=0?ROWS[quizRowIdx].chars:getAllChars();
  var opts=shuffle(all.filter(function(x){return x.h!==c.h}).slice(0,3));
  opts.push(c);opts=shuffle(opts);

  var box=document.getElementById('quizBox');
  var html='<div style="font-size:13px;color:var(--text-sub)">ç¬¬ '+(quizIdx+1)+'/'+quizData.length+' é¢˜</div>';

  if(quizMode==='listen'){
    html+='<div class="quiz-prompt">ğŸ”Š</div>';
    html+='<div class="quiz-prompt small">å¬å‘éŸ³ï¼Œé€‰æ­£ç¡®çš„å‡å</div>';
    html+='<div class="quiz-options">';
    opts.forEach(function(o,i){
      html+='<button class="quiz-opt" onclick="quizAnswer(this,'+i+',\''+o.h+'\',\''+c.h+'\')" style="font-family:\'M PLUS Rounded 1c\',sans-serif;font-size:28px">'+getDisplay(o)+'</button>';
    });
    html+='</div>';
    box.innerHTML=html;
    speakKana(c.h);
  }else if(quizMode==='read'){
    html+='<div class="quiz-prompt" style="font-family:\'M PLUS Rounded 1c\',sans-serif">'+getDisplay(c)+'</div>';
    html+='<div class="quiz-prompt small">è¿™ä¸ªå‡åçš„è¯»éŸ³æ˜¯ï¼Ÿ</div>';
    html+='<div class="quiz-options">';
    opts.forEach(function(o,i){
      html+='<button class="quiz-opt" onclick="quizAnswer(this,'+i+',\''+o.h+'\',\''+c.h+'\')">'+o.r+'</button>';
    });
    html+='</div>';
    box.innerHTML=html;
  }else if(quizMode==='word'){
    html+='<div style="margin:12px 0"><img src="../img/'+c.img+'" style="width:64px;height:64px;object-fit:contain"></div>';
    html+='<div class="quiz-prompt small">'+c.cn+' ('+c.word+') çš„ç¬¬ä¸€ä¸ªå‡åæ˜¯ï¼Ÿ</div>';
    html+='<div class="quiz-options">';
    opts.forEach(function(o,i){
      html+='<button class="quiz-opt" onclick="quizAnswer(this,'+i+',\''+o.h+'\',\''+c.h+'\')" style="font-family:\'M PLUS Rounded 1c\',sans-serif;font-size:28px">'+getDisplay(o)+'</button>';
    });
    html+='</div>';
    box.innerHTML=html;
  }
}

function quizAnswer(el,idx,picked,correct){
  var btns=document.querySelectorAll('.quiz-opt');
  btns.forEach(function(b){b.onclick=null});
  if(picked===correct){
    el.classList.add('correct');quizScore++;
    speakKana(correct);
  }else{
    el.classList.add('wrong');
    btns.forEach(function(b){
      if(b.textContent.trim().indexOf(correct)>=0||b.getAttribute('onclick').indexOf("'"+correct+"'")>=0){
        // Find the correct button â€” highlight it
      }
    });
    // Find correct button
    btns.forEach(function(b){
      var onc=b.getAttribute('onclick')||'';
      // Check by extracting the picked value from onclick
    });
  }
  if(!progress[correct]){
    progress[correct]={date:Date.now()};
    localStorage.setItem('gojuon_progress',JSON.stringify(progress));
    updateProgress();
  }
  setTimeout(function(){quizIdx++;showQuizQ()},1000);
}

function showQuizResult(){
  var box=document.getElementById('quizBox');
  var pct=Math.round(quizScore/quizData.length*100);
  var stars=pct>=90?'â­â­â­':pct>=70?'â­â­':'â­';
  var msg=pct>=90?'å¤ªæ£’äº†Alexï¼':pct>=70?'åšå¾—ä¸é”™ï¼':'ç»§ç»­åŠ æ²¹ï¼';
  var html='<div style="font-size:48px;margin:12px 0">'+stars+'</div>';
  html+='<div class="quiz-score">'+msg+' '+quizScore+'/'+quizData.length+' ('+pct+'%)</div>';
  html+='<button class="quiz-btn" onclick="startQuiz(\''+quizMode+'\')">å†æ¥ä¸€æ¬¡</button>';
  html+='<button class="quiz-btn secondary" onclick="switchTab(0)">è¿”å›äº”åéŸ³è¡¨</button>';
  box.innerHTML=html;
}

// ============================================================
// INIT
// ============================================================
renderAll();
switchTab(0);
// Restore saved voice preference
if(voiceMode!=='tts')setVoice(voiceMode);
</script>
</body>
</html>
